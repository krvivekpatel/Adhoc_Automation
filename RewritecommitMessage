#!/bin/bash

# ========== CONFIGURATION ==========
SOURCE_REPO_URL="<your-original-repo-url>"
BRANCH_NAME="<your-branch-name>"           # e.g., main or develop
NEW_REPO_URL="<your-new-repo-url>"
TEMP_DIR="jira-branch-rewrite-temp"
JIRA_KEY="[JIRA-123]"                      # <-- Replace with actual Jira key
# ===================================

echo "Cloning only branch '$BRANCH_NAME' from $SOURCE_REPO_URL ..."
git clone --branch "$BRANCH_NAME" --single-branch "$SOURCE_REPO_URL" "$TEMP_DIR"
cd "$TEMP_DIR" || exit 1

echo "Rewriting commit messages in branch '$BRANCH_NAME' ..."
git filter-repo --force --message-callback "
def callback(message):
    m = message.decode('utf-8')
    if '$JIRA_KEY' not in m:
        return ('$JIRA_KEY ' + m).encode('utf-8')
    return message
"

echo "Initializing new Git remote..."
git remote remove origin
git remote add origin "$NEW_REPO_URL"

echo "Pushing rewritten branch to $NEW_REPO_URL ..."
git push -u origin "$BRANCH_NAME" --force

echo "âœ… Done. Branch '$BRANCH_NAME' pushed to new repo with Jira keys added."
